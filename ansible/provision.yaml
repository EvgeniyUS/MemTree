---
- hosts: servers
  vars_files:
    - vars.yaml
  gather_facts: false
  become: yes

  tasks:
    - name: install system packages
      apt:
        pkg: "{{ item }}"
        update-cache: yes
      with_items: "{{ system_packages }}"

    - name: create directory for app
      file:
        path: "{{ project_path }}"
        state: directory

    - name: remove default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: create private key (RSA, 4096 bits)
      community.crypto.openssl_privatekey:
        path: "{{ key_path }}"

    - name: create simple self-signed certificate
      community.crypto.x509_certificate:
        path: "{{ cert_path }}"
        privatekey_path: "{{ key_path }}"
        provider: selfsigned

    - name: copy project files - item
      copy:
        src: "../memtree/item"
        dest: "{{ project_path }}/"
        mode: 600
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
      # notify:
      #   - restart daphne

    - name: copy project files - memtree
      copy:
        src: "../memtree/memtree"
        dest: "{{ project_path }}/"
        mode: 600
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
      # notify:
      #   - restart daphne

    - name: copy project files - manage.py
      copy:
        src: "../memtree/manage.py"
        dest: "{{ project_path }}/"
        mode: 600
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
      # notify:
      #   - restart daphne

    - name: copy project files - requirements.txt
      copy:
        src: "../memtree/requirements.txt"
        dest: "{{ project_path }}/"
        mode: 600
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
      # notify:
      #   - restart daphne

#    - name: copy project files - db.sqlite3
#      copy:
#        src: "../memtree/db.sqlite3"
#        dest: "{{ project_path }}/"
#        mode: 600
#        owner: root
#        group: root
#      notify:
#        - restart daphne

    - name: initiate virtualenv
      pip:
        virtualenv: "{{ venv_dir }}"
        virtualenv_command: /usr/bin/python3 -m venv
        requirements: "{{ project_path }}/requirements.txt"

    - name: create log directory
      file:
        path: "/var/log/{{ project_name }}"
        state: directory
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
        mode: 600

    - name: create django log file
      file:
        path: "/var/log/{{ project_name }}.django.log"
        state: touch
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
        mode: 600

    - name: create django log file
      file:
        path: "/var/log/{{ project_name }}.django.log"
        state: touch
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
        mode: 600

    - name: create django_redis log file
      file:
        path: "/var/log/{{ project_name }}.django_redis.log"
        state: touch
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
        mode: 600

    - name: create channels log file
      file:
        path: "/var/log/{{ project_name }}.channels.log"
        state: touch
        owner: "{{ project_owner }}"
        group: "{{ project_group }}"
        mode: 600

- import_playbook: deploy.yaml
