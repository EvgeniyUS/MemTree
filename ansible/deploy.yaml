---
- hosts: servers
  vars_files:
    - vars.yaml
  gather_facts: false
  become: yes

  tasks:
    - name: copy project files item
      copy:
        src: "../memtree/item"
        dest: "{{ project_path }}/"

    - name: copy project files memtree
      copy:
        src: "../memtree/memtree"
        dest: "{{ project_path }}/"

    - name: copy project files manage.py
      copy:
        src: "../memtree/manage.py"
        dest: "{{ project_path }}/"

    - name: copy project files requirements.txt
      copy:
        src: "../memtree/requirements.txt"
        dest: "{{ project_path }}/"
#      notify:
#        - restart daphne

    - name: initiate virtualenv
      pip:
        virtualenv: "{{ venv_dir }}"
        virtualenv_command: /usr/bin/python3 -m venv
        requirements: "{{ project_path }}/requirements.txt"

    - name: copy nginx config
      template:
        src: "files/nginx.j2"
        dest: "/etc/nginx/sites-enabled/{{ project_name }}.conf"
#      notify:
#        - restart nginx

#    - name: django migrate
#      django_manage:
#        command: migrate
#        app_path: {{ project_path }}
#        pythonpath: {{ venv_python }}
#
#    - name: django collectstatic
#      django_manage:
#        command: collectstatic
#        app_path: {{ project_path }}
#        pythonpath: {{ venv_python }}
#
#    - name: copy daphne config
#      template:
#        src: files/daphne.j2
#        dest: /etc/systemd/system/daphne.service
#      notify:
#        - restart daphne
#
#    - name: make sure nginx server is running
#      service:
#        name: nginx
#        state: started
#        enabled: yes
#
#    - name: make sure daphne server is running
#      service:
#        name: daphne
#        state: started
#        enabled: yes

  handlers:
    - name: restart nginx
      service:
        name: nginx
        state: restarted

    - name: restart daphne
      service:
        name: daphne
        state: restarted
